name: Deploy to cPanel

on:
  push:
    branches: [master]
  workflow_dispatch: {}

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      APP_DIR: /home/${{ secrets.CPANEL_USER }}/public_html/dashboard/naqla_dashboard
      NODE_VER: 14
      REPO_URL: https://github.com/MoltaqaFront/naqla_dashboard.git
      REPO_SLUG: /MoltaqaFront/naqla_dashboard.git
      GIT_TOKEN: ${{ secrets.GIT_TOKEN }}

    steps:
      - uses: actions/checkout@v4

      - name: Remote deploy (git reset and build)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.CPANEL_HOST }}
          username: ${{ secrets.CPANEL_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          envs: APP_DIR,NODE_VER,REPO_URL,REPO_SLUG,GIT_TOKEN
          script: |
            set -e

            echo "Deploying to $APP_DIR"
            mkdir -p "$APP_DIR"
            cd "$APP_DIR"

            # Ensure git repo exists and origin is set (tokenless)
            git rev-parse --is-inside-work-tree >/dev/null 2>&1 || git init -q
            if ! git remote get-url origin >/dev/null 2>&1; then
              git remote add origin "$REPO_URL"
            fi

            # Temporarily set origin to auth URL for fetch/reset, then restore
            AUTH_URL="https://x-access-token:${GIT_TOKEN}@github.com/${REPO_SLUG}"
            ORIGIN_URL="$(git remote get-url origin 2>/dev/null || echo "$REPO_URL")"
            git remote set-url origin "$AUTH_URL"
            git fetch --all --prune
            git reset --hard origin/master
            git remote set-url origin "$ORIGIN_URL"

            # Activate cPanel Node environment if available
            source ~/nodevenv/"$APP_DIR"/${NODE_VER}/bin/activate 2>/dev/null || true

            npm install
            npm run build

            # Extract files from dist folder and clean up
            echo "Extracting files from dist folder..."
            echo "Before extraction - directory contents:"
            ls -la

            if [ -d "dist" ]; then
              echo "Dist folder found. Contents:"
              ls -la dist/
              
              # Use cp and rm instead of mv to avoid issues with hidden files
              cp -r dist/* ./ 2>/dev/null || true
              
              # Handle hidden files separately
              find dist -name ".*" -exec cp -r {} ./ \; 2>/dev/null || true
              
              # Remove dist folder completely
              rm -rf dist/
              echo "Dist folder extracted and removed"
              
              echo "After extraction - directory contents:"
              ls -la
            else
              echo "No dist folder found!"
            fi

            # Handle all.css file if it exists in root
            echo "Organizing CSS files..."
            echo "Looking for all.css and css folder..."
            ls -la all.css 2>/dev/null || echo "No all.css in root"
            ls -la css/ 2>/dev/null || echo "No css folder found"

            if [ -f "all.css" ] && [ -d "css" ]; then
              mv all.css css/
              echo "Moved all.css to css folder"
            elif [ -f "all.css" ]; then
              echo "all.css found but no css folder, creating one"
              mkdir -p css
              mv all.css css/
            else
              echo "all.css already in correct location or doesn't exist"
            fi

            # Update HTML files to fix asset paths
            echo "Fixing asset paths in HTML files..."
            # List HTML files for debugging
            ls -la *.html 2>/dev/null || echo "No HTML files found in root"

            # Fix CSS and JS paths to match the publicPath
            find . -name "*.html" -type f -exec sed -i 's|href="css/|href="/dashboard/naqla_dashboard/css/|g' {} \;
            find . -name "*.html" -type f -exec sed -i 's|src="js/|src="/dashboard/naqla_dashboard/js/|g' {} \;
            find . -name "*.html" -type f -exec sed -i 's|href="all\.css"|href="/dashboard/naqla_dashboard/css/all.css"|g' {} \;

            echo "Asset paths updated in HTML files"

            echo "Deployment completed successfully"

