name: Deploy to cPanel

on:
  push:
    branches: [master]
  workflow_dispatch: {}

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      APP_DIR: /home/${{ secrets.CPANEL_USER }}/public_html/dashboard/naqla_dashboard
      NODE_VER: 14
      REPO_URL: https://github.com/MoltaqaFront/naqla_dashboard.git
      REPO_SLUG: /MoltaqaFront/naqla_dashboard.git
      GIT_TOKEN: ${{ secrets.GIT_TOKEN }}

    steps:
      - uses: actions/checkout@v4

      - name: Remote deploy (git reset and build)
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.CPANEL_HOST }}
          username: ${{ secrets.CPANEL_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          envs: APP_DIR,NODE_VER,REPO_URL,REPO_SLUG,GIT_TOKEN
          script: |
            set -e

            echo "Deploying to $APP_DIR"
            mkdir -p "$APP_DIR"
            cd "$APP_DIR"

            # Ensure git repo exists and origin is set (tokenless)
            git rev-parse --is-inside-work-tree >/dev/null 2>&1 || git init -q
            if ! git remote get-url origin >/dev/null 2>&1; then
              git remote add origin "$REPO_URL"
            fi

            # Temporarily set origin to auth URL for fetch/reset, then restore
            AUTH_URL="https://x-access-token:${GIT_TOKEN}@github.com/${REPO_SLUG}"
            ORIGIN_URL="$(git remote get-url origin 2>/dev/null || echo "$REPO_URL")"
            git remote set-url origin "$AUTH_URL"
            git fetch --all --prune
            git reset --hard origin/master
            git remote set-url origin "$ORIGIN_URL"

            # Activate cPanel Node environment if available
            source ~/nodevenv/"$APP_DIR"/${NODE_VER}/bin/activate 2>/dev/null || true

            npm install
            npm run build

            # Extract files from dist folder and clean up
            echo "Extracting files from dist folder..."
            if [ -d "dist" ]; then
              # Move all files from dist to current directory
              mv dist/* ./ 2>/dev/null || true
              # Move hidden files if any
              mv dist/.* ./ 2>/dev/null || true
              # Remove empty dist folder
              rmdir dist 2>/dev/null || true
              echo "Dist folder extracted and removed"
            fi

            # Move all.css to existing css folder if it exists
            echo "Organizing CSS files..."
            if [ -f "all.css" ] && [ -d "css" ]; then
              mv all.css css/
              echo "Moved all.css to existing css folder"
            fi

            # Update HTML files to reference css/all.css
            echo "Updating CSS references in HTML files..."
            find . -name "*.html" -type f -exec sed -i 's|href="/dashboard/all\.css"|href="/dashboard/css/all.css"|g' {} \;
            find . -name "*.html" -type f -exec sed -i 's|href="all\.css"|href="css/all.css"|g' {} \;
            echo "Updated CSS references in HTML files"

            echo "Deployment completed successfully"

